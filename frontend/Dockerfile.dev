FROM node:22-slim

WORKDIR /app

# Устанавливаем утилиты
RUN apt-get update && apt-get install -y --no-install-recommends dumb-init wget && rm -rf /var/lib/apt/lists/*

# Обновляем npm
RUN npm install -g npm@latest

# Копируем package.json И наш новый, правильный package-lock.json
COPY package.json ./

# 'npm ci' теперь установит ВСЕ, что указано в lock-файле, включая rollup
RUN npm install

# Копируем остальной код
COPY . .

# Создаем пользователя и выдаем права
RUN addgroup --gid 1001 nodejs && \
    adduser --uid 1001 --gid 1001 --shell /bin/sh --disabled-password nextjs && \
    chown -R nextjs:nodejs /app
USER nextjs

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1

ENTRYPOINT ["dumb-init", "--"]
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]