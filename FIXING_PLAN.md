# План исправления ошибок системы фактчекинга

## Обзор проблем

На основе анализа кода и логов выявлены следующие критические проблемы:

1. **Повторное скрапирование источников** - источники скрапируются несколько раз в процессе верификации
2. **Нефункциональный кэш** - кэш показывает 0.00% попаданий, постоянно "Cache miss"
3. **Источники не передаются в финальный результат** - API не возвращает источники во фронтенд
4. **Неэффективность процесса** - избыточные операции замедляют систему

## Этап 1: Глубокий анализ кода (Приоритет: ВЫСОКИЙ)

### 1.1 Анализ потока данных

- [ ] Проследить полный путь источников от скрапирования до API ответа
- [ ] Документировать все точки, где источники обрабатываются
- [ ] Выявить места потери данных об источниках

### 1.2 Анализ кэширования

- [ ] Проверить конфигурацию Redis в `app/redis_client.py`
- [ ] Проанализировать генерацию ключей кэша
- [ ] Выявить причины постоянных "Cache miss"

### 1.3 Файлы для анализа

- `agent/services/graph/verification/evidence_gatherer.py`
- `agent/services/graph/verification/source_manager.py`
- `agent/services/verdict.py`
- `app/services/verification_service.py`
- `app/redis_client.py`

## Этап 2: Создание тестовых сценариев (Приоритет: ВЫСОКИЙ)

### 2.1 Тестовые данные

- [ ] Создать набор тестовых изображений/постов
- [ ] Подготовить известные источники для тестирования
- [ ] Создать сценарии для проверки кэша

### 2.2 Мониторинг

- [ ] Добавить детальное логирование в ключевые точки
- [ ] Создать метрики для отслеживания производительности
- [ ] Настроить мониторинг использования кэша

## Этап 3: Исправление кэширования (Приоритет: ВЫСОКИЙ)

### 3.1 Диагностика Redis

```python
# Проверить подключение к Redis
# Проверить TTL ключей
# Проверить размер кэша
```

### 3.2 Исправление генерации ключей

- [ ] Проанализировать функцию `_generate_cache_key()` в `source_manager.py`
- [ ] Убедиться в консистентности ключей
- [ ] Добавить валидацию ключей

### 3.3 Оптимизация кэш-стратегии

- [ ] Настроить правильные TTL для разных типов данных
- [ ] Реализовать кэширование на разных уровнях
- [ ] Добавить метрики кэша

### 3.4 Файлы для изменения

- `app/redis_client.py`
- `agent/services/graph/verification/source_manager.py`
- `agent/services/intelligent_cache.py`

## Этап 4: Устранение повторного скрапирования (Приоритет: ВЫСОКИЙ)

### 4.1 Рефакторинг evidence_gatherer.py

```python
# Текущая проблема:
# 1. Скрапирование для оценки
# 2. Повторное скрапирование после селекции

# Решение:
# 1. Скрапировать один раз
# 2. Сохранить результаты
# 3. Использовать кэшированные данные
```

### 4.2 Изменения в логике

- [ ] Модифицировать `gather_evidence()` для однократного скрапирования
- [ ] Обновить `select_credible_sources()` для работы с кэшированными данными
- [ ] Убрать дублирующие вызовы скрапирования

### 4.3 Файлы для изменения

- `agent/services/graph/verification/evidence_gatherer.py`
- `agent/services/graph/verification/source_manager.py`

## Этап 5: Передача источников в результат (Приоритет: ВЫСОКИЙ)

### 5.1 Исправление VerdictService

```python
# В verdict.py, функция generate_verdict():
# Добавить sources в VerdictResult

verdict_result = VerdictResult(
    verdict=verdict_response.verdict,
    confidence_score=verdict_response.confidence_score,
    reasoning=verdict_response.reasoning,
    sources=collected_sources  # ДОБАВИТЬ ЭТО
)
```

### 5.2 Обновление API слоя

```python
# В verification_service.py, функция get_verification_status():
# Добавить sources в VerificationResponse

return VerificationResponse(
    status="completed",
    verification_id=verification_id,
    verdict=result.verdict,
    justification=result.reasoning,
    confidence_score=result.confidence_score,
    processing_time_seconds=result.processing_time_seconds,
    sources=result.sources  # ДОБАВИТЬ ЭТО
)
```

### 5.3 Файлы для изменения

- `agent/services/verdict.py`
- `app/services/verification_service.py`
- `app/schemas/api.py` (если нужно обновить схему)

## Этап 6: Обновление базы данных (Приоритет: СРЕДНИЙ)

### 6.1 Миграция схемы

- [ ] Создать миграцию Alembic для добавления поля sources
- [ ] Обновить модель VerificationResult в базе данных
- [ ] Протестировать миграцию

### 6.2 Файлы для изменения

- `app/models/` (модели базы данных)
- `alembic/versions/` (новая миграция)

## Этап 7: Исправление фронтенда (Приоритет: СРЕДНИЙ)

### 7.1 Обновление отображения источников

- [ ] Убрать заглушки из `ResultDisplay.tsx`
- [ ] Обеспечить корректное отображение реальных источников
- [ ] Добавить обработку случаев отсутствия источников

### 7.2 Файлы для изменения

- `frontend/src/components/ResultDisplay.tsx`

## Этап 8: Мониторинг и тестирование (Приоритет: НИЗКИЙ)

### 8.1 Комплексное тестирование

- [ ] Протестировать полный цикл верификации
- [ ] Проверить работу кэша
- [ ] Убедиться в передаче источников

### 8.2 Мониторинг производительности

- [ ] Измерить время обработки до и после изменений
- [ ] Проверить эффективность кэширования
- [ ] Мониторить использование ресурсов

## Этап 9: Развертывание (Приоритет: НИЗКИЙ)

### 9.1 Поэтапное развертывание

- [ ] Развернуть изменения в тестовой среде
- [ ] Провести нагрузочное тестирование
- [ ] Развернуть в продакшене

### 9.2 Откат

- [ ] Подготовить план отката
- [ ] Создать резервные копии
- [ ] Настроить мониторинг после развертывания

## Ожидаемые результаты

После выполнения плана:

1. **Производительность**: Сокращение времени обработки на 40-60%
2. **Кэширование**: Достижение 70-80% попаданий в кэш
3. **Функциональность**: Корректное отображение источников во фронтенде
4. **Эффективность**: Устранение избыточных операций скрапирования

## Приоритизация исправлений

### Высокий приоритет (немедленно)

1. Исправление повторного скрапирования
2. Починка кэша
3. Передача источников в API

### Средний приоритет (в течение недели)

1. Обновление базы данных
2. Исправление фронтенда

### Низкий приоритет (по возможности)

1. Комплексное тестирование
2. Мониторинг и развертывание

## Контрольные точки

- [ ] Этап 1-3: Анализ и диагностика (2-3 дня)
- [ ] Этап 4-5: Основные исправления (3-5 дней)
- [ ] Этап 6-7: Дополнительные улучшения (2-3 дня)
- [ ] Этап 8-9: Тестирование и развертывание (2-3 дня)

**Общее время выполнения: 9-14 дней**
